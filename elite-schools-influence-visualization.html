<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Elite Schools Influence Map</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;500;600;700&family=Source+Serif+Pro:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      :root {
        --ink: #1a1a1a;
        --muted: #5a5a5a;
        --paper: #f7f2ea;
        --accent: #124559;
        --accent-2: #c44900;
        --accent-3: #2b7a6d;
        --card: #ffffff;
        --shadow: 0 14px 32px rgba(0, 0, 0, 0.08);
        --outline: rgba(26, 26, 26, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Source Sans Pro", "Segoe UI", sans-serif;
        color: var(--ink);
        background: radial-gradient(900px 520px at 10% 10%, #f0e7d7 0%, transparent 55%),
          radial-gradient(900px 520px at 90% 0%, #e0efe9 0%, transparent 55%),
          var(--paper);
      }

      header {
        padding: 40px 24px 20px;
        text-align: center;
        max-width: 980px;
        margin: 0 auto;
      }

      h1 {
        font-family: "Source Serif Pro", Georgia, serif;
        font-size: clamp(30px, 5vw, 44px);
        margin: 0 0 12px;
      }

      header p {
        margin: 0 auto;
        max-width: 720px;
        color: var(--muted);
        font-size: 16px;
      }

      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px 40px;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
        margin: 18px 0 24px;
      }

      .controls label,
      .controls select {
        font-size: 14px;
      }

      .controls select,
      .controls button {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--outline);
        background: var(--card);
        font-family: inherit;
      }

      .controls button {
        background: var(--accent);
        color: #fff;
        border: none;
        cursor: pointer;
      }

      .controls button:hover {
        background: #0f3746;
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        gap: 20px;
        align-items: stretch;
      }

      .panel {
        background: var(--card);
        border-radius: 18px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(18, 69, 89, 0.1);
        padding: 18px;
      }

      #network {
        height: 520px;
      }

      #map {
        height: 520px;
        border-radius: 14px;
        overflow: hidden;
      }

      .panel h2 {
        margin: 0 0 12px;
        font-size: 18px;
        font-weight: 600;
        color: var(--accent);
      }

      .panel small {
        color: var(--muted);
      }

      .info-panel {
        margin-top: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #fff 0%, #f9f5ee 100%);
        border-radius: 18px;
        border: 1px solid rgba(18, 69, 89, 0.12);
        box-shadow: var(--shadow);
      }

      .info-title {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .school-name {
        font-family: "Source Serif Pro", Georgia, serif;
        font-size: 24px;
        margin: 0;
      }

      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        background: #e7f2f4;
        color: var(--accent);
        margin-right: 6px;
      }

      .section {
        margin-top: 16px;
      }

      .section h3 {
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin: 0 0 8px;
      }

      .badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .badge {
        padding: 6px 10px;
        border-radius: 10px;
        background: #f1f6f3;
        font-size: 12px;
        color: #1f4a3c;
        border: 1px solid rgba(31, 74, 60, 0.15);
      }

      .mobility {
        display: grid;
        gap: 10px;
      }

      .mobility-step {
        padding: 10px 12px;
        border-radius: 10px;
        background: #fff;
        border-left: 3px solid var(--accent-3);
        box-shadow: 0 8px 14px rgba(0, 0, 0, 0.06);
      }

      .mobility-step strong {
        display: block;
        font-size: 13px;
        margin-bottom: 4px;
      }

      .retention-grid {
        display: grid;
        gap: 8px;
      }

      .retention-bar {
        background: #f1f1f1;
        border-radius: 999px;
        overflow: hidden;
        height: 10px;
      }

      .retention-bar span {
        display: block;
        height: 100%;
        background: var(--accent-2);
      }

      .retention-row {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: var(--muted);
      }

      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
      }

      .legend-swatch {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .note {
        margin-top: 16px;
        font-size: 12px;
        color: var(--muted);
      }

      .methodology p,
      .methodology ul {
        margin: 8px 0 0;
        font-size: 13px;
        color: var(--muted);
      }

      .methodology {
        margin-top: 20px;
      }

      .methodology ul {
        padding-left: 18px;
      }

      .methodology a {
        color: var(--accent);
        text-decoration: none;
      }

      .methodology a:hover {
        text-decoration: underline;
      }

      .story-card {
        background: #ffffff;
        border-radius: 12px;
        border-left: 4px solid var(--accent-2);
        padding: 12px 14px;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.08);
        font-size: 13px;
        color: var(--ink);
      }

      .story-meta {
        display: flex;
        gap: 10px;
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
      }

      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }

        #network,
        #map {
          height: 460px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <a href="../index.html" style="color: var(--ink, #1a1a1a); text-decoration: none; font-size: 20px; font-weight: 600;">OpenPinas</a>
        <span style="font-size: 12px; color: var(--muted, #5a5a5a);" id="lastUpdated">Last updated: Loading...</span>
      </div>
      <h1>Elite Schools Influence Map</h1>
      <p>
        Schools appear as nodes. Pipelines show where graduates work and lead. Province overlays show
        concentration and retention so this does not read as prestige alone.
      </p>
    </header>

    <div class="wrap">
      <div class="controls">
        <select id="tierFilter">
          <option value="all">All Tiers</option>
          <option value="National Elite">National Elite</option>
          <option value="Leading Private">Leading Private</option>
          <option value="Leading Regional">Leading Regional</option>
        </select>
        <select id="pipelineFilter">
          <option value="all">All Pipelines</option>
          <option value="public_service">Public Service</option>
          <option value="business">Business</option>
          <option value="academia">Academia</option>
          <option value="civil_society">Civil Society</option>
          <option value="health">Health</option>
          <option value="industry">Industry</option>
        </select>
        <select id="overlayFilter">
          <option value="influence">Province Overlay: Influence</option>
          <option value="retention">Province Overlay: Retention</option>
        </select>
        <button id="resetSelection">Reset Selection</button>
      </div>

      <div class="grid">
        <div class="panel">
          <h2>Alumni Pipelines Network</h2>
          <small>Click a school node to see community loops, mobility paths, and where graduates stayed.</small>
          <div id="network"></div>
          <div class="legend" id="networkLegend"></div>
        </div>
        <div class="panel">
          <h2>Provincial Influence Overlay</h2>
          <small>Province overlays show concentration and retention, not just metro pull.</small>
          <div id="map"></div>
          <div class="note">
            Province shapes and scores are illustrative placeholders. Replace with official geojson and validated data.
          </div>
        </div>
      </div>

      <div class="info-panel" id="infoPanel">
        <div class="info-title">
          <h2 class="school-name">Select a school node</h2>
          <div id="schoolPills"></div>
        </div>
        <p id="schoolSummary" class="note">Click a school node to see its community loops, mobility paths, and in-region retention.</p>
        <div id="schoolDetails"></div>
      </div>

      <div class="panel methodology">
        <h2>Methodology Notes (Prototype)</h2>
        <p>
          This prototype uses placeholder scores to test layout and narrative flow. When real data is
          added, sources should include program accreditation and board performance baselines.
        </p>
        <ul>
          <li><a href="https://ched.gov.ph/" target="_blank" rel="noopener">CHED</a> for higher education listings and program data.</li>
          <li><a href="https://www.prc.gov.ph/board-exam-results" target="_blank" rel="noopener">PRC Board Exam Results</a> for licensure performance trends.</li>
          <li><a href="https://paascu.org.ph/" target="_blank" rel="noopener">PAASCU</a> for accreditation levels.</li>
        </ul>
      </div>
    </div>

    <script>
      const dataUrl = "elite-schools-influence-2025.json";
      const provinceUrl = "elite-schools-provinces.geojson";
      
      // Update last updated timestamp
      fetch(dataUrl)
        .then(res => res.json())
        .then(data => {
          const lastUpdated = data.metadata?.last_updated || 'Unknown';
          const lastUpdatedEl = document.getElementById('lastUpdated');
          if (lastUpdatedEl) {
            lastUpdatedEl.textContent = `Last updated: ${lastUpdated}`;
          }
        })
        .catch(() => {
          const lastUpdatedEl = document.getElementById('lastUpdated');
          if (lastUpdatedEl) {
            lastUpdatedEl.textContent = `Last updated: Unknown`;
          }
        });

      const tierColors = {
        "National Elite": "#124559",
        "Leading Private": "#c44900",
        "Leading Regional": "#2b7a6d"
      };

      const sectorColors = {
        public_service: "#355c7d",
        business: "#6c5b7b",
        academia: "#4f6d7a",
        civil_society: "#2a9d8f",
        health: "#e76f51",
        industry: "#f4a261"
      };

      let schools = [];
      let pipelines = [];
      let sectors = [];
      let provinceLayer;
      let selectedSchoolId = null;

      const networkContainer = document.getElementById("network");
      const infoPanel = document.getElementById("infoPanel");
      const schoolPills = document.getElementById("schoolPills");
      const schoolDetails = document.getElementById("schoolDetails");
      const schoolSummary = document.getElementById("schoolSummary");

      const tierFilter = document.getElementById("tierFilter");
      const pipelineFilter = document.getElementById("pipelineFilter");
      const overlayFilter = document.getElementById("overlayFilter");
      const resetSelection = document.getElementById("resetSelection");

      const nodes = new vis.DataSet();
      const edges = new vis.DataSet();
      let network;
      let map;

      const makeLegend = () => {
        const legend = document.getElementById("networkLegend");
        legend.innerHTML = "";
        Object.entries(tierColors).forEach(([tier, color]) => {
          const item = document.createElement("div");
          item.className = "legend-item";
          item.innerHTML = `<span class="legend-swatch" style="background:${color}"></span>${tier}`;
          legend.appendChild(item);
        });
      };

      const buildNetwork = () => {
        nodes.clear();
        edges.clear();

        schools.forEach((school) => {
          nodes.add({
            id: school.id,
            label: school.name,
            group: school.tier,
            shape: "dot",
            size: 12 + school.influence_score / 8,
            color: {
              background: tierColors[school.tier],
              border: "#0f2e3a"
            },
            font: { color: "#1a1a1a" },
            title: `${school.name} (${school.tier})`
          });
        });

        sectors.forEach((sector) => {
          nodes.add({
            id: sector.id,
            label: sector.name,
            shape: "box",
            size: 16,
            color: {
              background: "#f2f2f2",
              border: "#c8c8c8"
            },
            font: { color: "#4d4d4d" },
            title: `Pipeline: ${sector.name}`
          });
        });

        pipelines.forEach((pipe) => {
          edges.add({
            id: pipe.id,
            from: pipe.from,
            to: pipe.to,
            color: sectorColors[pipe.type] || "#999",
            width: Math.max(1.5, pipe.strength / 30),
            title: `Pipeline strength: ${pipe.strength}`
          });
        });

        const options = {
          physics: {
            stabilization: true,
            barnesHut: { springLength: 120, springConstant: 0.03 }
          },
          interaction: { hover: true },
          nodes: { borderWidth: 1 },
          edges: { smooth: true, opacity: 0.7 }
        };

        network = new vis.Network(networkContainer, { nodes, edges }, options);
        network.on("click", (params) => {
          if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const school = schools.find((item) => item.id === nodeId);
            if (school) {
              selectedSchoolId = school.id;
              renderSchoolInfo(school);
              updateProvinceStyles();
            }
          }
        });
      };

      const renderSchoolInfo = (school) => {
        document.querySelector(".school-name").textContent = school.name;
        const pills = [
          `<span class="pill">${school.tier}</span>`,
          `<span class="pill">${school.sector}</span>`
        ];
        schoolPills.innerHTML = pills.join("");

        schoolSummary.textContent = `Footprint score ${school.influence_score}/100. Pipelines show where graduates work, and retention shows who stayed.`;

        const badgeItems = []
          .concat(school.community_loops.scholarships)
          .concat(school.community_loops.outreach)
          .concat(school.community_loops.campuses)
          .map((item) => `<span class="badge">${item}</span>`)
          .join("");

        const mobilitySteps = school.mobility_paths
          .map(
            (step) => `
              <div class="mobility-step">
                <strong>${step.step}</strong>
                <div>${step.detail}</div>
              </div>
            `
          )
          .join("");

        const retentionRows = school.retention.sectors
          .map((sector) => {
            const width = `${sector.value}%`;
            return `
              <div class="retention-row">
                <span>${sector.name}</span>
                <span>${sector.value}%</span>
              </div>
              <div class="retention-bar">
                <span style="width: ${width}"></span>
              </div>
            `;
          })
          .join("");

        const storyCard = `
          <div class="story-card">
            <strong>${school.micro_story.title}</strong>
            <div>${school.micro_story.outcome}</div>
            <div class="story-meta">
              <span>Stayed in: ${school.micro_story.location}</span>
              <span>Sector: ${school.micro_story.sector}</span>
            </div>
          </div>
        `;

        schoolDetails.innerHTML = `
          <div class="section">
            <h3>Community Loop Badges</h3>
            <div class="badges">${badgeItems}</div>
          </div>
          <div class="section">
            <h3>Mobility Paths</h3>
            <div class="mobility">${mobilitySteps}</div>
          </div>
          <div class="section">
            <h3>Provincial Talent Retention</h3>
            <div class="retention-grid">
              <div class="retention-row">
                <span>Graduates staying in-region</span>
                <span>${school.retention.stay_rate}%</span>
              </div>
              ${retentionRows}
            </div>
          </div>
          <div class="section">
            <h3>Micro-Story: Where Alumni Stayed + Built</h3>
            ${storyCard}
          </div>
          <div class="section" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(18, 69, 89, 0.15);">
            <h3>Related Visualizations</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
              <a href="dynasties-network-visualization.html" target="_blank" style="display: inline-block; padding: 6px 12px; background: #f1f6f3; border: 1px solid rgba(18, 69, 89, 0.15); border-radius: 6px; font-size: 12px; color: #0b6e4f; text-decoration: none;">Dynasty Map →</a>
              <a href="startup-ecosystem-visualization.html" target="_blank" style="display: inline-block; padding: 6px 12px; background: #f1f6f3; border: 1px solid rgba(18, 69, 89, 0.15); border-radius: 6px; font-size: 12px; color: #0038A8; text-decoration: none;">Startup Ecosystem →</a>
              <a href="business-connections-network-visualization.html" target="_blank" style="display: inline-block; padding: 6px 12px; background: #f1f6f3; border: 1px solid rgba(18, 69, 89, 0.15); border-radius: 6px; font-size: 12px; color: #8b008b; text-decoration: none;">Business Connections →</a>
            </div>
          </div>
        `;
      };

      const resetInfo = () => {
        selectedSchoolId = null;
        document.querySelector(".school-name").textContent = "Select a school node";
        schoolPills.innerHTML = "";
        schoolSummary.textContent =
          "Click a school node to see its community loops, mobility paths, and in-region retention.";
        schoolDetails.innerHTML = "";
        updateProvinceStyles();
      };

      const pipelineToSectorId = {
        public_service: "SECTOR_PUBLIC",
        business: "SECTOR_BUSINESS",
        academia: "SECTOR_ACADEMIA",
        civil_society: "SECTOR_CIVIL",
        health: "SECTOR_HEALTH",
        industry: "SECTOR_INDUSTRY"
      };

      const updateVisibility = () => {
        const tierValue = tierFilter.value;
        const pipelineValue = pipelineFilter.value;
        const activeSectorId = pipelineToSectorId[pipelineValue];

        nodes.forEach((node) => {
          if (node.id.startsWith("SECTOR_")) {
            nodes.update({ id: node.id, hidden: pipelineValue !== "all" && node.id !== activeSectorId });
          } else {
            nodes.update({
              id: node.id,
              hidden: tierValue !== "all" && node.group !== tierValue
            });
          }
        });

        edges.forEach((edge) => {
          edges.update({
            id: edge.id,
            hidden: pipelineValue !== "all" && edge.color !== sectorColors[pipelineValue]
          });
        });
      };

      const getColor = (value, palette) => {
        if (value >= 85) return palette[3];
        if (value >= 70) return palette[2];
        if (value >= 55) return palette[1];
        return palette[0];
      };

      const updateProvinceStyles = () => {
        if (!provinceLayer) return;
        const overlay = overlayFilter.value;
        provinceLayer.setStyle((feature) => {
          const influence = feature.properties.influence_score;
          const retention = feature.properties.retention_index;
          const palette = overlay === "retention"
            ? ["#fbe4d5", "#f4a261", "#e76f51", "#c44900"]
            : ["#dbe9f2", "#7fb3c8", "#3b84a7", "#124559"];
          const value = overlay === "retention" ? retention : influence;
          const isHighlighted =
            selectedSchoolId &&
            feature.properties.school_presence &&
            feature.properties.school_presence.includes(selectedSchoolId);

          return {
            fillColor: getColor(value, palette),
            weight: isHighlighted ? 2.5 : 1,
            color: isHighlighted ? "#111" : "#666",
            fillOpacity: isHighlighted ? 0.8 : 0.6
          };
        });
      };

      const initMap = async () => {
        map = L.map("map", { zoomControl: true }).setView([12.5, 121.8], 5.5);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        const response = await fetch(provinceUrl);
        const geojson = await response.json();

        provinceLayer = L.geoJSON(geojson, {
          style: () => ({
            fillColor: "#dbe9f2",
            weight: 1,
            color: "#666",
            fillOpacity: 0.6
          }),
          onEachFeature: (feature, layer) => {
            layer.bindTooltip(
              `<strong>${feature.properties.province}</strong><br/>Influence: ${feature.properties.influence_score}<br/>Retention: ${feature.properties.retention_index}%`
            );
          }
        }).addTo(map);

        updateProvinceStyles();
      };

      const init = async () => {
        const response = await fetch(dataUrl);
        const data = await response.json();
        schools = data.schools;
        pipelines = data.pipelines;
        sectors = data.sectors;

        makeLegend();
        buildNetwork();
        initMap();
      };

      tierFilter.addEventListener("change", updateVisibility);
      pipelineFilter.addEventListener("change", updateVisibility);
      overlayFilter.addEventListener("change", updateProvinceStyles);
      resetSelection.addEventListener("click", resetInfo);

      init();
    </script>
  </body>
</html>
